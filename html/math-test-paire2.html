<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حيلة غاوس – تزاوج الأعداد (سُلّم المكعبات)</title>
  <!-- يمكنك وضع فافكون داخل مجلد فرعي هكذا: -->
  <link rel="icon" href="./assets/favicon.ico">
  <!-- لتفادي 404 عند غياب الفافكون كليًا يمكن استخدام فافكون شفافة:
  <link rel="icon" href="data:,"> -->
  <style>
    :root{
      --block: 28px;            /* حجم المربّع */
      --gap: 6px;               /* المسافة بين المربعات */
      --a: #2563eb;             /* لون أساسي (A) */
      --b: #10b981;             /* لون مكمل (B) */
      --bg: #0b1220;            /* خلفية داكنة أنيقة */
      --panel: #0f172a;         /* لوح التحكم */
      --text: #e2e8f0;          /* نص */
      --muted: #94a3b8;         /* نص ثانوي */
      --accent: #f59e0b;        /* إبراز */
      --pair-outline: #f59e0bcc;/* حدود عند الاكتمال */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:System-ui,Segoe UI,Roboto,Tajawal,Arial,Helvetica,sans-serif;background:linear-gradient(120deg,#0a0f1d,#111827);color:var(--text)}
    header{ padding:18px 20px 8px; text-align:center; line-height:1.5; }
    header h1{margin:0;font-size:1.4rem;font-weight:800}
    header p{margin:.3rem 0 0;color:var(--muted);font-size:.95rem}

    .shell{max-width:1000px;margin:0 auto;padding:10px 16px 32px}

    .panel{ background:var(--panel);border:1px solid #1e293b; border-radius:16px; padding:14px; display:flex;flex-wrap:wrap;align-items:center;gap:10px;box-shadow:0 10px 30px rgb(0 0 0 / .25) }
    .panel label{font-size:.9rem;color:var(--muted)}
    .panel input[type=range]{width:200px}
    .panel .btn{ appearance:none;border:none;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:700;background:#1f2937;color:#e5e7eb;transition:.2s transform, .2s opacity, .2s background; }
    .panel .btn:hover{transform:translateY(-2px);background:#374151}
    .panel .btn:active{transform:translateY(0)}
    .panel .btn.primary{background:var(--a);color:white}
    .panel .btn.primary:hover{background:#1d4ed8}
    .panel .btn.ghost{background:transparent;border:1px solid #334155}

    .arena{ position:relative; margin:18px auto 6px; padding:18px; border-radius:18px; border:1px solid #1e293b; background: radial-gradient(1200px 400px at 50% -10%, rgba(59,130,246,.18), rgba(16,185,129,.12) 30%, rgba(0,0,0,0) 70%), #0b1220; box-shadow:inset 0 1px 0 rgba(255,255,255,.03); }
    .arena .grid{display:flex;flex-direction:column;align-items:flex-start;gap:var(--gap);min-height:calc( (var(--block) + var(--gap)) * 8 );}

    .row{display:flex;align-items:center;gap:var(--gap);position:relative;min-height:var(--block)}
    .row .label{width:40px;text-align:center;color:var(--muted);font-size:.85rem}

    .group{display:flex;gap:var(--gap)}
    .block{width:var(--block);height:var(--block);border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06)}
    .block.a{background:linear-gradient(180deg, #3b82f6, #1e40af)}
    .block.b{background:linear-gradient(180deg, #34d399, #065f46)}

    /* مجموعة المكمل (B) تبدأ خارج المشهد لأسفل ثم تصعد أثناء الأنيميشن */
    .group.b{transform:translateY(110%);opacity:0}
    .group.b.in{transform:translateY(0);opacity:1;transition:transform 600ms cubic-bezier(.2,.8,.2,1), opacity 600ms ease}

    .wrap{display:flex;align-items:flex-end;gap:12px}

    .legend{display:flex;gap:12px;align-items:center;margin-top:10px;color:var(--muted);font-size:.9rem}
    .k{display:inline-flex;align-items:center;gap:6px}
    .pill{width:14px;height:14px;border-radius:4px;display:inline-block}

    .formula{margin-top:16px;border-top:1px dashed #273449;padding-top:12px;color:#e5e7eb}
    .formula .eq{font-weight:800}
    .hint{color:var(--muted);font-size:.9rem}

    .footer{margin-top:8px;color:var(--muted);font-size:.85rem;text-align:center}

    /* مستطيل الإطار بعد اكتمال التزاوج (للتوضيح البصري لـ n × (n+1)) */
    .arena.complete::after{ content:""; position:absolute; inset:18px; border:2px dashed var(--pair-outline); border-radius:14px; pointer-events:none; animation:outlinePulse 1.2s ease 1; }
    @keyframes outlinePulse{0%{transform:scale(.98);opacity:.4}100%{transform:scale(1);opacity:1}}

    /* أسهم/أيقونات التوضيح */
    .spacer{ position:relative; width:24px; display:flex; align-items:center; justify-content:center; }
    .pairArrow{ font-size:18px; line-height:1; color:var(--accent); opacity:0; transform:translateY(8px); transition:opacity .35s ease, transform .35s ease; }
    .pairArrow.show{ opacity:1; transform:none; }

    .guides{ position:absolute; inset:18px; width:calc(100% - 36px); height:calc(100% - 36px); pointer-events:none; opacity:0; transition:opacity .35s ease; }
    .arena.complete .guides{ opacity:.95; }
    .guides text{ font: 600 14px System-ui, Tajawal, sans-serif; fill:#e5e7eb; }
    .guides .tMuted{ fill: var(--muted); }
    .guides line{ stroke: var(--accent); stroke-width:2; }

    /* شرح بعد اكتمال التزاوج */
    .postExplain{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,6,23,.0),rgba(2,6,23,.55));opacity:0;transform:scale(.98);pointer-events:none;transition:opacity .35s ease, transform .3s ease; z-index:5;}
    .arena.complete .postExplain{opacity:1;transform:none;pointer-events:auto}
    .postExplain.hidden{ display:none !important; }
    .postExplain .card{background:var(--panel);border:1px solid #334155;border-radius:16px;padding:16px 18px;max-width:720px;box-shadow:0 24px 60px rgba(0,0,0,.35)}
    .postExplain h3{margin:.2rem 0  .4rem;font-size:1.1rem}
    .postExplain p{margin:.35rem 0;color:var(--text)}
    .postExplain .muted{color:var(--muted)}
    .btn.small{padding:8px 10px;font-size:.9rem;border-radius:10px}

    /* استجابة */
    @media (max-width:600px){ :root{--block:22px; --gap:5px} .panel{gap:8px} .panel input[type=range]{width:140px} }
  </style>
</head>
<body>
  <header>
    <h1>حيلة غاوس – تجميع (تزاوج) الأعداد بصريًا</h1>
    <p>نُنشئ سُلّمًا من المكعبات من 1 إلى <b id="nLabel">20</b>، ثم نُكمّله بمكعبات مكافئة لتكوين مستطيل أبعاده <span id="dimsLabel">20 × 21</span> ليتضح أن <span class="eq">2S = n(n+1)</span> ثم <span class="eq">S = n(n+1)/2</span>.</p>
  </header>

  <div class="shell">
    <div class="panel" role="region" aria-label="لوح التحكم">
      <label for="n">عدد الدرجات (n): <b id="nVal">20</b></label>
      <input id="n" type="range" min="1" max="30" step="1" value="20" aria-label="عدد الدرجات" />
      <label for="speed">السرعة:</label>
      <select id="speed" aria-label="سرعة الأنيميشن">
        <option value="800">بطيء</option>
        <option value="600" selected>متوسط</option>
        <option value="350">سريع</option>
      </select>
      <button class="btn primary" id="play">تشغيل التزاوج</button>
      <button class="btn ghost" id="step">خطوة</button>
      <button class="btn ghost" id="reset">إعادة الضبط</button>
      <span class="hint">نصيحة: عدّل n ثم اضغط تشغيل. يمكنك المشاهدة خطوة بخطوة أيضًا.</span>
    </div>

    <div class="arena" id="arena">
      <div class="grid" id="grid" aria-live="polite"></div>
      <!-- طبقة SVG للأسهم الإيضاحية (تظهر بعد الاكتمال) -->
      <svg id="guides" class="guides" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <marker id="arrowHead" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto">
            <path d="M0,0 L8,4 L0,8 Z" fill="currentColor"></path>
          </marker>
        </defs>
        <line id="hLine" x1="0" y1="0" x2="0" y2="0" marker-start="url(#arrowHead)" marker-end="url(#arrowHead)"/>
        <line id="vLine" x1="0" y1="0" x2="0" y2="0" marker-start="url(#arrowHead)" marker-end="url(#arrowHead)"/>
        <text id="hText" x="0" y="0">n+1</text>
        <text id="vText" x="0" y="0" transform="rotate(-90 0,0)">n</text>
      </svg>
      <div class="legend" aria-hidden="true">
        <span class="k"><span class="pill" style="background:linear-gradient(180deg,#3b82f6,#1e40af)"></span> السُلّم الأصلي (A)</span>
        <span class="k"><span class="pill" style="background:linear-gradient(180deg,#34d399,#065f46)"></span> المكمل (B) لإكمال المستطيل</span>
      </div>
      <div class="formula" id="formula">
        <div>2S = n(n+1) ← لأن سُلّمين متكاملين يشكّلان مستطيلًا بعدده <span id="rectCells">420</span> مكعبًا.</div>
        <div>إذن S = n(n+1)/2 = <b id="sum">210</b> مكعّبًا.</div>
      </div>

      <div class="postExplain" id="postExplain" role="status" aria-live="polite">
        <div class="card">
          <h3>الآن أصبح الشكل <span style="color:var(--accent);font-weight:800">مُستطيلاً</span></h3>
          <p>الأبعاد: <b><span id="dimA">20</span> × <span id="dimB">21</span></b>.</p>
          <p>مساحة المستطيل = الطول × العرض = <b id="areaVal">420</b> مكعبًا، وتمثّل عدد المكعبات داخل المستطيل، أي مكعبات السُلّمين معًا (<b>2S</b>).</p>
          <p>لكننا نريد مكعبات <b>سُلّم واحد فقط</b> ⇒ الجواب النهائي هو <b>نصف</b> هذا العدد:
            <span class="eq">S = n(n+1)/2 = <span id="sumVal">210</span></span>.
          </p>
          <button class="btn ghost small" id="dismiss">إخفاء الشرح</button>
        </div>
      </div>
    </div>

    <div class="footer">صُمِّم للشرح الصفي لمرحلة الصف الخامس–السابع. يمكنك تعديل عدد الدرجات والسرعة، وتشغيل الأنيميشن خطوة بخطوة.</div>
  </div>

  <script>
    // ===== أدوات مساعدة آمنة =====
    const $ = (id)=>document.getElementById(id);
    const safeText = (id, v)=>{ const el = $(id); if (el) el.textContent = v; };

    // مراجع عامة
    const nInput = $('n');
    const nVal   = $('nVal');
    const nLabel = $('nLabel');
    const dimsLabel = $('dimsLabel');
    const rectCells = $('rectCells');
    const sumEl  = $('sum');
    const grid   = $('grid');
    const arena  = $('arena');
    const playBtn= $('play');
    const stepBtn= $('step');
    const resetBtn=$('reset');
    const speedSel=$('speed');

    const postExplain = $('postExplain');
    const dimA = $('dimA');
    const dimB = $('dimB');
    const areaVal = $('areaVal');
    const sumVal = $('sumVal');
    const dismissBtn = $('dismiss');

    // طبقة الأسهم الإيضاحية
    const guides = $('guides');
    const hLine = $('hLine');
    const vLine = $('vLine');
    const hText = $('hText');
    const vText = $('vText');

    let currentN = parseInt(nInput.value, 10);
    let stepIndex = 0; // أي صف تم إدخاله من مجموعة B
    let explainTimer = null;

    // بناء المشهد بالكامل
    function build(n){
      grid.innerHTML = '';
      arena.classList.remove('complete');
      if(postExplain) postExplain.classList.remove('hidden');
      if(explainTimer) { clearTimeout(explainTimer); explainTimer = null; }
      stepIndex = 0;

      for(let r=1; r<=n; r++){
        const row = document.createElement('div'); row.className='row';
        const label = document.createElement('div'); label.className='label'; label.textContent = r; row.appendChild(label);

        const groupA = document.createElement('div'); groupA.className='group a';
        for(let i=0;i<r;i++){ const b=document.createElement('div'); b.className='block a'; groupA.appendChild(b); }
        row.appendChild(groupA);

        const spacer = document.createElement('div'); spacer.className='spacer';
        const arrowMid = document.createElement('div'); arrowMid.className='pairArrow'; arrowMid.textContent='↔';
        spacer.appendChild(arrowMid); row.appendChild(spacer);

        const groupB = document.createElement('div'); groupB.className='group b'; groupB.dataset.size = (n+1-r);
        for(let i=0;i<(n+1-r);i++){ const b=document.createElement('div'); b.className='block b'; groupB.appendChild(b); }
        row.appendChild(groupB);

        grid.appendChild(row);
      }

      // تحديث العناوين والقيم — بشكل آمن
      safeText('nVal', n);
      safeText('nLabel', n);
      safeText('dimsLabel', `${n} × ${n+1}`);
      safeText('rectCells', n*(n+1));
      safeText('sum', (n*(n+1))/2);
      safeText('dimA', n);
      safeText('dimB', n+1);
      safeText('areaVal', n*(n+1));
      safeText('sumVal', (n*(n+1))/2);

      // ضبط عرض الحلبة تقريبًا بحيث تتسع للمستطيل n × (n+1)
      const block = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--block'));
      const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
      const approxWidth = (block + gap) * (n+1) + 140; // + مساحة الأرقام يمين الصف
      grid.style.minWidth = Math.max(approxWidth, 420) + 'px';
    }

    // إظهار مجموعة B في صف واحد (خطوة)
    function revealRowB(index){
      const rows = Array.from(grid.querySelectorAll('.row'));
      if(index >= rows.length) return false;
      const b = rows[index].querySelector('.group.b');
      if(!b) return false;
      const duration = parseInt(speedSel.value,10);
      // force reflow to ensure transition applies even when toggled quickly
      b.getBoundingClientRect();
      b.style.transitionDuration = duration+'ms';
      b.classList.add('in');
      const arrow = rows[index].querySelector('.pairArrow');
      if(arrow){ arrow.classList.add('show'); }
      return true;
    }

    // تشغيل متتابع
    async function play(){
      playBtn.disabled = true; stepBtn.disabled = true; nInput.disabled = true; speedSel.disabled = true;
      const rows = Array.from(grid.querySelectorAll('.row'));
      const duration = parseInt(speedSel.value,10);
      for(let i=stepIndex;i<rows.length;i++){
        revealRowB(i);
        stepIndex = i+1;
        await new Promise(res=>setTimeout(res, duration*0.9));
      }
      markComplete();
      playBtn.disabled = false; stepBtn.disabled = false; nInput.disabled = false; speedSel.disabled = false;
    }

    function markComplete(){
      arena.classList.add('complete');
      // تحديث القيم في نافذة الشرح/الصيغة
      safeText('dimA', currentN);
      safeText('dimB', currentN+1);
      safeText('areaVal', currentN*(currentN+1));
      safeText('sumVal', (currentN*(currentN+1))/2);
      if(typeof updateGuides === 'function'){ updateGuides(); }
      if(postExplain){
        postExplain.classList.remove('hidden');
        if(explainTimer) { clearTimeout(explainTimer); }
        explainTimer = setTimeout(()=>{
          if(!postExplain.classList.contains('hidden')) postExplain.classList.add('hidden');
        }, 10000);
      }
    }

    function reset(){ build(currentN); }

    // دالة تحديث مواضع الأسهم الإيضاحية (الأبعاد n و n+1)
    function updateGuides(){
      if(!guides) return;
      if(!arena.classList.contains('complete')) return;
      const firstA = grid.querySelector('.row .group.a .block');
      const firstRow = grid.querySelector('.row');
      const lastRow = grid.querySelector('.row:last-child');
      const lastRowAny = lastRow ? (lastRow.querySelector('.group.a .block') || lastRow.querySelector('.block')) : null;
      const lastBFirstRow = firstRow ? firstRow.querySelector('.group.b .block:last-child') : null;
      if(!firstA || !lastRowAny || !lastBFirstRow) return;

      const aRect = arena.getBoundingClientRect();
      const pad = 18; // نفس قيمة inset في .guides
      const offsetLeft = aRect.left + pad;
      const offsetTop = aRect.top + pad;

      const rA = firstA.getBoundingClientRect();
      const rBend = lastBFirstRow.getBoundingClientRect();
      const rLast = lastRowAny.getBoundingClientRect();

      const x1 = rA.left - offsetLeft;
      const x2 = rBend.right - offsetLeft;
      const yMid = (rA.top - offsetTop) + rA.height/2;
      const y1v = rA.top - offsetTop;
      const y2v = rLast.bottom - offsetTop;
      const xV = x1 - 10; // سهم رأسي على يسار السلم بقليل

      const w = aRect.width - 2*pad;
      const h = aRect.height - 2*pad;
      guides.setAttribute('viewBox', `0 0 ${w} ${h}`);

      hLine.setAttribute('x1', x1); hLine.setAttribute('y1', yMid);
      hLine.setAttribute('x2', x2); hLine.setAttribute('y2', yMid);
      vLine.setAttribute('x1', xV); vLine.setAttribute('y1', y1v);
      vLine.setAttribute('x2', xV); vLine.setAttribute('y2', y2v);

      hText.setAttribute('x', (x1+x2)/2 - 16);
      hText.setAttribute('y', yMid - 8);
      hText.textContent = (currentN + 1) + ' (n+1)';

      vText.setAttribute('x', xV - 10);
      vText.setAttribute('y', (y1v + y2v)/2 + 12);
      vText.textContent = currentN + ' (n)';
    }

    // أحداث الواجهة
    nInput.addEventListener('input', e=>{ currentN = parseInt(e.target.value,10); build(currentN); });
    playBtn.addEventListener('click', play);
    stepBtn.addEventListener('click', ()=>{ const ok = revealRowB(stepIndex); if(ok){ stepIndex++; if(stepIndex===currentN){ markComplete(); } } });
    resetBtn.addEventListener('click', reset);

    if(dismissBtn){
      dismissBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        if(explainTimer){ clearTimeout(explainTimer); explainTimer=null; }
        postExplain?.classList.add('hidden');
      });
    }
    if(postExplain){
      // إخفاء عند النقر خارج البطاقة
      postExplain.addEventListener('click', (e)=>{ if(e.target === postExplain){ postExplain.classList.add('hidden'); } });
      const card = postExplain.querySelector('.card');
      if(card){ card.addEventListener('click', (e)=> e.stopPropagation()); }
    }

    window.addEventListener('resize', ()=>{ if(arena.classList.contains('complete')) updateGuides(); });

    // تهيئة أولية
    build(currentN);
  </script>
</body>
</html>
